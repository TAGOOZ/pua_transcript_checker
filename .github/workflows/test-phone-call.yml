name: Test Phone Call

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-call:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install requests

      - name: Test phone call
        run: |
          cat << 'EOF' | python3
          import requests
          import hashlib
          import time

          print("Testing phone call with proper fingerprinting...")
          print("=" * 50)

          phone_number = "+201211310357"
          phone_encoded = "%2B201211310357"

          # Create fresh session to get uid from server
          session = requests.Session()

          print("Step 1: Getting fresh session...")
          init_response = session.get(
              "https://callmyphone.org/",
              headers={
                  "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                  "user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 Chrome/144.0.0.0"
              },
              timeout=30
          )
          print(f"Init response: {init_response.status_code}")
          print(f"Cookies received: {dict(session.cookies)}")

          # Generate fingerprint matching Fingerprint2 style
          fgp = str(abs(hash(f"linux_chrome_{time.time()}")) % 10000000000)
          fgp2 = hashlib.md5(f"{phone_number}{fgp}".encode()).hexdigest()

          print(f"Step 2: Generated fgp={fgp}, fgp2={fgp2}")

          # Make the call
          print("Step 3: Making call request...")
          response = session.post(
              "https://callmyphone.org/do-call",
              headers={
                  "accept": "application/json, text/javascript, */*; q=0.01",
                  "content-type": "application/x-www-form-urlencoded; charset=UTF-8",
                  "origin": "https://callmyphone.org",
                  "referer": "https://callmyphone.org/",
                  "user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 Chrome/144.0.0.0",
                  "x-requested-with": "XMLHttpRequest"
              },
              data={
                  "phone": phone_encoded,
                  "browser": "undefined;",
                  "fgp": fgp,
                  "fgp2": fgp2,
                  "rememberNumber": "1"
              },
              timeout=30
          )

          print(f"Response status: {response.status_code}")
          print(f"Response body: {response.text}")

          if "limit_exceed" in response.text.lower() or "exhausted" in response.text.lower():
              print("⚠️ RATE LIMITED")
          elif response.status_code == 200 and "maxCallDuration" in response.text:
              print("✅ Phone call initiated successfully!")
          else:
              print("❌ Call may have failed")
          EOF
